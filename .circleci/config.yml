version: 2.1

jobs:
  checkoutEtTests:
    docker:
      - image: cimg/node:15.8.0
    steps:
      - checkout:
          path: ~/repo
      - run: 
          name: Installer les dépendances et exécuter les tests dans le backend
          command: |
            cd ~/repo
            npm install
            npm test

  integrationFrontend:
    docker:
      - image: cimg/node:15.8.0
    steps:
      - run:
          name: Cloner le répertoire frontend
          command: |
            git clone -b frontend https://github.com/gwefoss/labo2CircleCI.git ~/repo
            cd ~/repo
            npm install
            npm run build
      - run:
          name: Cloner le répertoire backend et préparer le répertoire public
          command: |
            git clone -b backend https://github.com/gwefoss/labo2CircleCI.git ~/backend
            mkdir -p ~/backend/public
            cp -R ~/repo/build/* ~/backend/public/
      - persist_to_workspace:
          root: ~/backend
          paths:
            - public

  deploiement:
    docker:
      - image: cimg/node:15.8.0
    steps:
      - attach_workspace:
          at: ~/backend
      - run:
          name: Lister le contenu du répertoire backend
          command: |
            ls -Rl ~/backend

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - checkoutEtTests:
          filters:
            branches:
              only: backend
      - integrationFrontend:
          requires:
            - checkoutEtTests
          filters:
            branches:
              only: frontend
      - deploiement:
          requires:
            - integrationFrontend
          filters:
            branches:
              only: backend
